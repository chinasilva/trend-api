name: Fetch Trends

on:
  schedule:
    # 每 30 分钟执行一次
    - cron: '*/30 * * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch all trends
        id: fetch-trends
        run: |
          # 触发爬取并保存快照
          RESPONSE=$(curl -s -X POST "${{ secrets.API_URL }}/api/trends/sync" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Parse and log results
        run: |
          RESPONSE=${{ steps.fetch-trends.outputs.response }}

          # 检查是否是有效 JSON
          if ! echo "$RESPONSE" | jq -e . > /dev/null 2>&1; then
            echo "========== API 请求失败 =========="
            echo "❌ 无法获取数据，API 返回无效响应"
            echo "================================"
            echo "success=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 检查整体成功状态
          OVERALL_SUCCESS=$(echo "$RESPONSE" | jq -r '.success')

          # 平台名称映射
          PLATFORM_NAMES='{"douyin":"抖音","weibo":"微博","zhihu":"知乎","baidu":"百度","weixin":"微信","bilibili":"B站","xiaohongshu":"小红书","weixinvideo":"视频号"}'

          # 统计变量
          TOTAL=0
          SUCCESS_COUNT=0
          FAILED_COUNT=0

          # 遍历每个平台
          for platform in douyin weibo zhihu baidu weixin bilibili xiaohongshu weixinvideo; do
            PLATFORM_NAME=$(echo "$PLATFORM_NAMES" | jq -r ".$platform")
            TOTAL=$((TOTAL + 1))

            # 从新的响应格式中获取成功数量
            SUCCESS=$(echo "$RESPONSE" | jq -r --arg platform "$platform" '((.data.platforms // []) | map(select(.platform == $platform)) | .[0].successCount) // 0')
            FAILED=$(echo "$RESPONSE" | jq -r --arg platform "$platform" '((.data.platforms // []) | map(select(.platform == $platform)) | .[0].failCount) // 0')

            # 判断成功/失败：successCount > 0 表示成功
            if [ "$SUCCESS" = "0" ] && [ "$FAILED" = "0" ]; then
              FAILED_COUNT=$((FAILED_COUNT + 1))
              echo "========== ${PLATFORM_NAME}热榜 =========="
              echo "❌ 失败: 爬取失败或无数据"
              echo "   获取了 0 条数据"
              echo ""
            elif [ "$SUCCESS" -gt 0 ]; then
              # 有数据，成功
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "========== ${PLATFORM_NAME}热榜 =========="
              echo "✅ 成功: $SUCCESS 条数据"
              echo ""
            else
              FAILED_COUNT=$((FAILED_COUNT + 1))
              echo "========== ${PLATFORM_NAME}热榜 =========="
              echo "❌ 失败: $FAILED 条数据"
              echo ""
            fi
          done

          echo "================================"
          echo "总计: $TOTAL 个平台, $SUCCESS_COUNT 个成功, $FAILED_COUNT 个失败"

          # 即使有失败也不失败（保持 workflow 成功）
          echo "success=true" >> $GITHUB_OUTPUT
        env:
          CI: true
