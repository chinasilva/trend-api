generator client {
  provider = "prisma-client-js"
  // 使用 binary 引擎，配合 PrismaPg 适配器连接 pgbouncer
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // URL is configured in prisma.config.ts for Prisma 7
}

model TrendSource {
  id        String   @id @default(cuid())
  platform  String   @unique // 平台名称: douyin, weibo, zhihu, baidu, weixin, bilibili, xiaohongshu, weixinvideo
  name      String   // 显示名称
  icon      String?  // 图标
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trends    Trend[]
  contents  Content[]
}

model Trend {
  id          String   @id @default(cuid())
  sourceId    String
  source      TrendSource @relation(fields: [sourceId], references: [id])
  title       String      // 标题
  hotValue    Int?        // 热度值
  url         String?     // 原文链接
  description String?     // 描述
  rank        Int         // 排名
  thumbnail   String?     // 封面图
  extra       Json?       // 额外数据
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 去重约束：同一来源下，标题+URL 唯一
  @@unique([sourceId, title, url])
  @@index([sourceId, rank])
  @@index([createdAt])
}

// 内容表 - 去重后的内容实体
model Content {
  id          String     @id @default(cuid())
  sourceId    String
  source      TrendSource @relation(fields: [sourceId], references: [id])
  title       String
  url         String?
  description String?
  thumbnail   String?
  extra       Json?

  snapshots   Snapshot[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([sourceId, title, url])  // 去重
}

// 快照表 - 每次爬取的记录
model Snapshot {
  id        String   @id @default(cuid())
  contentId String
  content   Content  @relation(fields: [contentId], references: [id])
  rank      Int
  hotValue  Int?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([contentId, createdAt])
}
